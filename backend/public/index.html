<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ANS SIB Beneficiários</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;

    function App() {
      const [file, setFile] = useState(null);
      const [xml, setXml] = useState("");
      const [isValid, setIsValid] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");

      const handleFileChange = (e) => {
        setFile(e.target.files[0]);
        setError("");
      };

      const handleUpload = async () => {
        if (!file) {
          setError("Por favor, selecione um arquivo CSV");
          return;
        }
        
        setLoading(true);
        setError("");
        
        try {
          const formData = new FormData();
          formData.append("file", file);
          
          const uploadRes = await axios.post("/api/csv/upload", formData, {
            headers: {
              'Content-Type': 'multipart/form-data'
            }
          });
          
          const processRes = await axios.post("/api/csv/process", { 
            filePath: uploadRes.data.filePath 
          });
          
          setXml(processRes.data.xml);
          setIsValid(processRes.data.isValid);
        } catch (err) {
          setError(err.response?.data?.error || "Erro ao processar arquivo");
        } finally {
          setLoading(false);
        }
      };

      const handleDownload = () => {
        const blob = new Blob([xml], { type: "application/xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "beneficiarios_sib.xml";
        a.click();
        URL.revokeObjectURL(url);
      };

      return (
        <div className="container mt-5">
          <div className="row justify-content-center">
            <div className="col-md-8">
              <div className="card">
                <div className="card-header">
                  <h3 className="card-title mb-0">
                    <i className="bi bi-file-earmark-medical"></i> 
                    ANS SIB - Gerador de XML de Beneficiários
                  </h3>
                </div>
                <div className="card-body">
                  <div className="mb-4">
                    <label htmlFor="csvFile" className="form-label">
                      Selecione o arquivo CSV com dados dos beneficiários:
                    </label>
                    <input 
                      type="file" 
                      id="csvFile"
                      accept=".csv" 
                      onChange={handleFileChange} 
                      className="form-control" 
                    />
                    <div className="form-text">
                      Arquivo deve conter as colunas: Nome, CPF, DataNascimento, etc.
                    </div>
                  </div>
                  
                  {error && (
                    <div className="alert alert-danger" role="alert">
                      <i className="bi bi-exclamation-triangle"></i> {error}
                    </div>
                  )}
                  
                  <button 
                    className="btn btn-primary btn-lg w-100" 
                    onClick={handleUpload} 
                    disabled={loading || !file}
                  >
                    {loading ? (
                      <>
                        <span className="spinner-border spinner-border-sm me-2" role="status"></span>
                        Processando...
                      </>
                    ) : (
                      <>
                        <i className="bi bi-gear"></i> Gerar XML
                      </>
                    )}
                  </button>
                  
                  {isValid !== null && (
                    <div className={`alert mt-4 ${isValid ? "alert-success" : "alert-danger"}`}>
                      <h6 className="alert-heading">
                        {isValid ? (
                          <><i className="bi bi-check-circle"></i> XML Válido!</>
                        ) : (
                          <><i className="bi bi-x-circle"></i> XML Inválido!</>
                        )}
                      </h6>
                      XML {isValid ? "está conforme" : "não está conforme"} os schemas XSD da ANS
                    </div>
                  )}
                  
                  {xml && (
                    <div className="mt-4">
                      <button 
                        className="btn btn-success btn-lg w-100" 
                        onClick={handleDownload}
                      >
                        <i className="bi bi-download"></i> Download XML
                      </button>
                    </div>
                  )}
                </div>
                
                <div className="card-footer text-muted">
                  <small>
                    Sistema de geração de XML conforme especificações ANS/SIB |
                    <a href="https://www.gov.br/ans/pt-br/sobre-o-sib" target="_blank" className="ms-1">
                      Saiba mais sobre o SIB
                    </a>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</body>

</html>
